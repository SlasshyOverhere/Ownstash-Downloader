# In-Built Media Player Implementation Guide

This guide documents the "Exact Replica" of our robust media player system, designed for instant playback, smart file detection, and streaming stability.

## 1. System Architecture

The player consists of three main components:
1.  **Media Server (Backend)**: A local HTTP server (Rust/Warp) that streams video files with full `Range` request support, allowing instant seeking and playback of large files.
2.  **Smart Matcher (Backend)**: A robust algorithm to find the correct video file even if the title differs slightly (e.g., removing special chars, matching significant words).
3.  **React Player (Frontend)**: A custom UI component using HTML5 Video, integrated with the backend stream.

## 2. Backend Implementation (Restored)

The `src-tauri/src/media_server.rs` file has been restored with the robust logic.

### Key Features of the Backend:
-   **Warp Server**: runs on port `18456` locally.
-   **`find_best_media_match`**: Uses a word-frequency matching algorithm (not just exact match) to find the correct file.
-   **`get_media_stream_url`**: Generates a localhost URL (`http://127.0.0.1:18456/stream?path=...`) which is often more reliable than `asset://` for certain browser engines regarding buffering.

## 3. Frontend Integration

We have integrated the backend commands into `lib.rs`.

### How to use in Frontend (`MediaPlayer.tsx`):

Currently, your `MediaPlayer.tsx` might use `convertFileSrc`. If you experience buffering issues or seeking lag, switch to using the media server URL:

```typescript
// In src/components/MediaPlayer.tsx

import { invoke } from '@tauri-apps/api/core';

// ... inside component ...
const [streamUrl, setStreamUrl] = useState<string>('');

useEffect(() => {
    async function loadStream() {
        if (filePath) {
            // Option 1: Use the robust media server
            try {
                const url = await invoke<string>('get_media_stream_url', { filePath });
                setStreamUrl(url);
            } catch (e) {
                console.error("Failed to get stream URL, falling back to asset protocol", e);
                setStreamUrl(convertFileSrc(filePath));
            }
        }
    }
    loadStream();
}, [filePath]);

// Then use streamUrl in <video src={streamUrl} ... />
```

## 4. Troubleshooting "Instant Playback"

If playback isn't instant:
1.  **Transcoding**: Ensure `api.transcodeForPlayback` is called before opening the player (as done in `DownloadsPage.tsx`). This converts non-web-friendly formats (MKV) to MP4/WebM.
2.  **Matching**: The new `find_best_media_match` command is aggressive. Check the console logs `[MediaServer]` to see if it's picking the right file.
3.  **Preloading**: HTML5 video `preload="auto"` is set by default in most React players, but ensure it's not set to `none`.

## 5. Files Modified
-   `src-tauri/src/media_server.rs`: Created/Restored.
-   `src-tauri/src/lib.rs`: Registered module and commands.
-   `src-tauri/Cargo.toml`: Ensured dependencies (warp, etc).
