# Slasshy OmniDownloader v2.0: The Authoritative Blueprint
# IDM-Replaceable Architecture (Final Production-Grade Design)

## 0. The Core Philosophy
A professional downloader is defined by its **behavior under hostile conditions**. 
- **Reliability** via Control Systems is the foundation.
- **Transparency** (Engine Badges) is the bond of trust.
- **Graceful Degradation** is the operational reality.

---

## 1. Engine Transparency (Defensive UX)
Explicit user-visible labeling of the active engine to manage expectations:
- **[ SNDE ACCELERATED ]**: Raw speed for static binaries/archives.
- **[ MEDIA ENGINE ]**: Maximum compatibility for streaming platforms (yt-dlp).
*Trust is maintained by identifying why a download might be slower.*

---

## 2. The Integrated State Machine: Router + Watchdog
This is the "Brain" of the system, combining initial decision-making with runtime adaptation.

### 2.1 Preflight Decision (Initial Routing)
1. **Heuristics**: Match against media domains (yt-dlp) or static extensions (SNDE).
2. **Probes**: 2s timeout `Range: bytes=0-0` check.
3. **Historical Memory (New)**: Check "Host Reputation Table". If `example.com` historically fails at 8 connections, the router overrides and starts at a "Safe Default".

### 2.2 Runtime Strategy Manager (The Watchdog)
Continuous monitoring of **Health Metrics** (not just speed):
- **Metrics**: Median throughput per connection, error rate per segment, retry density, stall duration, and server response codes.
- **Strategy Collapse (Automatic)**: 
    - High error rates/throttling → Auto-collapse connections (e.g., 8 → 4 → 1).
    - Throttling signature detected → Toggle "Safe Mode" (single connection, HTTP/2 allowed).
- **Engine Switching (Explicit Only)**: 
    - **SNDE → SNDE Safe** is automatic.
    - **SNDE → Media Engine** is NEVER automatic mid-flight. It must be a user-visible action offered after failure to prevent state corruption.

---

## 3. Advanced Operational Mechanics

### 3.1 Protocol Intelligence
- **SNDE Segmented**: Force HTTP/1.1 for guaranteed TCP-level parallelism.
- **SNDE Safe / Media Engine**: Allow HTTP/2/3 for better congestion control and multiplexing on sensitive streams.

### 3.2 Safe Range Management
- **Rule**: NO mid-stream range splitting.
- **Logic**: Idle workers may only "steal" unstarted, future byte ranges from the queue of slower workers. This avoids CDN fingerprinting and 403 bans.

### 3.3 Anti-Freeze Disk Policy (Windows Optimized)
- **< 8GB**: Immediate full pre-allocation (`set_len`).
- **8GB - 32GB**: Chunked pre-allocation (4GB growing intervals).
- **> 32GB**: Lazy growth with write-ahead guardrails to prevent UI/System freezing (Antivirus/EDR friendly).

---

## 4. Host Reputation Memory (The Moat)
Maintain a lightweight local database/table of host-specific behavior:
- `domain`: e.g., "fastcdn.com"
- `max_stable_conns`: e.g., 8
- `favored_protocol`: e.g., HTTP/1.1
- `last_health_score`: 0-100
*Goal: Start at the optimal speed instead of trial-and-error every time.*

---

## 5. Global Scheduler (Resource Arbitration)
- **Traffic Shaping**: Prevent multiple concurrent downloads from starving each other's TCP windows.
- **Priority**: Active (UI-focused) downloads get first-class bandwidth allocation.

---

## 6. Implementation Roadmap (Final)

### Phase 1: The Core Control System
- Design `download_router.rs` + `watchdog.rs` as a unified state machine.
- Implement the **Health Metric** registry and **Host Reputation** table.

### Phase 2: SNDE Adaptive implementation
- Reqwest/Tokio-based downloader with dynamic connection collapsing.
- Forced HTTP/1.1 logic.

### Phase 3: Media Engine Integration
- yt-dlp JSON wrapper with unified health reporting.
- Frontend "Engine Badges" implementation.

### Phase 4: Operational Polish
- Tiered disk allocation logic.
- Global Scheduler for multi-task stability.

---
**Status**: DESIGN LOCKED & AUTHORITATIVE
**Target**: Slasshy OmniDownloader v2.0 "The Bulletproof System"
**Updated Date**: 2025-12-24
